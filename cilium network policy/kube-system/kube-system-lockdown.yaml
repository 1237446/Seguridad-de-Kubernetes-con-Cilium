apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: kube-system-unlabeled-lockdown
  namespace: kube-system
spec:
  endpointSelector:
    matchExpressions:
      # EXCLUSIONES: No aplicar bloqueo a estos pods (ya tienen sus propias reglas)
      - key: k8s-app
        operator: NotIn
        values: [kube-dns, cilium, hubble-relay, hubble-ui, cilium-operator]
      - key: app
        operator: NotIn
        values: [rke2-metrics-server]
      - key: component
        operator: NotIn
        values: [etcd, kube-apiserver, kube-scheduler, kube-controller-manager]
      - key: app.kubernetes.io/name
        operator: NotIn
        values: [tetragon, cilium-envoy]
  ingress:
    - fromEntities:
        - kube-apiserver
  egress:
    - toEntities:
        - kube-apiserver
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": kube-system
            "k8s-app": rke2-coredns # Ajustado al label de RKE2
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY