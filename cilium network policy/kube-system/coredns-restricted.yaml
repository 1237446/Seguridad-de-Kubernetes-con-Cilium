apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: coredns-restricted-fixed
  namespace: kube-system
spec:
  endpointSelector:
    matchLabels:
      k8s-app: kube-dns
  ingress:
    # 1. Permitir consultas DNS desde cualquier Pod o Nodo
    - fromEndpoints:
        - {} 
      fromEntities:
        - host
        - remote-node
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY
  egress:
    # 1. Permitir salida DNS hacia el mundo (Forwarders como 8.8.8.8) y Nodos
    - toEntities:
        - world
        - host
        - remote-node
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY
    # 2. CR√çTICO: Permitir que CoreDNS hable con el API Server
    # Sin esto, CoreDNS no puede leer los servicios del cluster
    - toEntities:
        - kube-apiserver